<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Street Stickers AR — AR.js + Firebase</title>

  <!-- A-Frame + AR.js (GPS) -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- AR.js (A-Frame build with GPS components) -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <!-- Leaflet CSS + JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (keep same major version as your original) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onChildRemoved, get } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";

    // Expose firebase helpers to the page by attaching to window.firebaseApp
    window._firebase = { initializeApp, getDatabase, ref, push, onChildAdded, onChildRemoved, get, initializeApp, getDatabase, ref };

    // IMPORTANT: we cannot initialize here because this script is a module and other inline scripts need the firebase API.
    // We'll initialize later in the main non-module script using the same firebaseConfig you provided.
  </script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height:100%; width:100%; background:#040404; color:#fff; font-family: Inter, system-ui, Arial; overflow:hidden; }
    /* Simple layout: pages stacked, we toggle .active */
    .page { position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:18px; }
    .page.active { display:flex; }
    /* Home */
    #homePage { flex-direction:column; gap:18px; }
    .btn { background:#111; color:#fff; border:2px solid rgba(255,255,255,0.06); padding:14px 22px; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn.secondary { background:transparent; border:2px solid #666; }
    /* Draw page */
    #drawCanvas { background:#fff; border-radius:12px; width:86vw; max-width:420px; height:86vw; max-height:420px; touch-action:none; display:block; }
    .controls { margin-top:12px; display:flex; gap:10px; align-items:center; }
    /* Map page */
    #map { width:100%; height:100%; }
    /* AR page (A-Frame fills page) */
    #arPage { padding:0; }
    .ui-overlay { position:fixed; z-index:9999; left:50%; transform:translateX(-50%); bottom:18px; display:flex; gap:8px; }
    .top-status { position:fixed; left:50%; transform:translateX(-50%); top:18px; padding:8px 12px; background:rgba(0,0,0,0.6); border-radius:8px; font-size:14px; }
    .reticle { pointer-events:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:40px; height:40px; border:2px solid #7fff6f; border-radius:50%; box-shadow:0 0 18px rgba(127,255,111,0.25); }
  </style>
</head>
<body>

  <!-- HOME -->
  <div id="homePage" class="page active">
    <h1 style="font-size:36px;margin-bottom:6px;">Surfaceless NYC</h1>
    <p style="max-width:420px; text-align:center; color:#ddd;">Create stickers and place them at real lat/long. Everyone sees them at the same spot — no device-to-device comms required.</p>
    <div style="display:flex; gap:12px; margin-top:18px;">
      <button id="createStickerBtn" class="btn">Create</button>
      <button id="exploreBtn" class="btn secondary">Explore (AR)</button>
      <button id="mapBtn" class="btn secondary">Map</button>
    </div>
  </div>

  <!-- DRAW -->
  <div id="drawPage" class="page">
    <div style="display:flex;flex-direction:column;align-items:center;">
      <canvas id="drawCanvas" width="512" height="512"></canvas>
      <div class="controls">
        <label style="color:#fff;">Color</label>
        <input id="colorPicker" type="color" value="#FF1493"/>
        <label style="color:#fff;">Size</label>
        <input id="sizeRange" type="range" min="2" max="40" value="8"/>
        <button id="clearDrawBtn" class="btn secondary">Clear</button>
      </div>
      <div style="margin-top:12px;">
        <button id="saveStickerBtn" class="btn">Save & Place</button>
        <button id="backToHomeBtn" class="btn secondary">Back</button>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="mapPage" class="page">
    <div id="map"></div>
    <div style="position:fixed;left:12px;top:12px;z-index:1000;">
      <button id="backFromMapBtn" class="btn secondary">Back</button>
    </div>
  </div>

  <!-- AR (A-Frame + AR.js) -->
  <div id="arPage" class="page">
    <!-- A-Frame scene with AR.js attribute: arjs with gps -->
    <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false;" renderer="logarithmicDepthBuffer: true;">
      <!-- AR camera that includes GPS component -->
      <a-entity camera gps-camera rotation-reader></a-entity>

      <!-- stickers will be appended as <a-image gps-entity-place ...> elements via JS -->
    </a-scene>

    <div class="reticle"></div>
    <div class="top-status" id="arStatus">Initializing AR...</div>

    <div class="ui-overlay">
      <button id="placeStickerBtn" class="btn" style="display:none;">Place Here</button>
      <button id="exitArBtn" class="btn secondary">Exit</button>
    </div>
  </div>

  <!-- SCRIPTS: non-module so firebase config can be used directly -->
  <script>
  // ---------- FIREBASE INITIALIZATION (kept exactly as you provided) ----------
  // using non-module Firebase CDN via dynamic import helper (we already imported module but to keep compatibility we re-init via module dynamic import)
  (async function initFirebase() {
    // Use module imports we attached earlier if available
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js');
    const { getDatabase, ref, push, onChildAdded, onChildRemoved, get } = await import('https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js');

    const firebaseConfig = {
      apiKey: "AIzaSyBCzRpUX5mexhGj5FzqEWKoFAdljNJdbHE",
      authDomain: "surfaceless-firebase.firebaseapp.com",
      databaseURL: "https://surfaceless-firebase-default-rtdb.firebaseio.com",
      projectId: "surfaceless-firebase",
      storageBucket: "surfaceless-firebase.firebasestorage.app",
      messagingSenderId: "91893983357",
      appId: "1:91893983357:web:a823ba9f5874bede8b6914"
    };

    window._fb = {};
    window._fb.app = initializeApp(firebaseConfig);
    window._fb.db = getDatabase(window._fb.app);
    window._fb.stickersRef = ref(window._fb.db, 'stickers');

    // expose push/get/onChildAdded etc
    window._fb.push = push;
    window._fb.onChildAdded = onChildAdded;
    window._fb.onChildRemoved = onChildRemoved;
    window._fb.get = get;

    // After firebase is ready, initialize app logic
    mainInit();
  })();

  // ---------- APP UI & CORE ----------
  function mainInit() {
    // DOM
    const homePage = document.getElementById('homePage');
    const drawPage = document.getElementById('drawPage');
    const arPage = document.getElementById('arPage');
    const mapPage = document.getElementById('mapPage');

    const createStickerBtn = document.getElementById('createStickerBtn');
    const exploreBtn = document.getElementById('exploreBtn');
    const mapBtn = document.getElementById('mapBtn');

    const drawCanvas = document.getElementById('drawCanvas');
    const colorPicker = document.getElementById('colorPicker');
    const sizeRange = document.getElementById('sizeRange');
    const clearDrawBtn = document.getElementById('clearDrawBtn');
    const saveStickerBtn = document.getElementById('saveStickerBtn');
    const backToHomeBtn = document.getElementById('backToHomeBtn');

    const placeStickerBtn = document.getElementById('placeStickerBtn');
    const exitArBtn = document.getElementById('exitArBtn');
    const arStatus = document.getElementById('arStatus');

    const backFromMapBtn = document.getElementById('backFromMapBtn');

    // state
    let pendingStickerImage = null;
    let userCoords = null; // {lat, lon, alt, accuracy}
    let lastCompass = null;
    let lastQuat = null;

    function showPage(page) {
      [homePage, drawPage, arPage, mapPage].forEach(p => p.classList.remove('active'));
      if (page === 'home') homePage.classList.add('active');
      if (page === 'draw') drawPage.classList.add('active');
      if (page === 'ar') arPage.classList.add('active');
      if (page === 'map') mapPage.classList.add('active');
    }

    // drawing setup
    const ctx = drawCanvas.getContext('2d');
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = colorPicker.value;
    ctx.lineWidth = sizeRange.value;

    let drawing = false;
    function toCanvasPos(e) {
      const rect = drawCanvas.getBoundingClientRect();
      const x = (e.clientX ?? e.touches?.[0]?.clientX) - rect.left;
      const y = (e.clientY ?? e.touches?.[0]?.clientY) - rect.top;
      return { x: x * (drawCanvas.width / rect.width), y: y * (drawCanvas.height / rect.height) };
    }
    drawCanvas.addEventListener('pointerdown', (e) => {
      drawing = true;
      ctx.strokeStyle = colorPicker.value;
      ctx.lineWidth = sizeRange.value;
      const p = toCanvasPos(e);
      ctx.beginPath(); ctx.moveTo(p.x, p.y);
    });
    drawCanvas.addEventListener('pointermove', (e) => {
      if (!drawing) return;
      const p = toCanvasPos(e);
      ctx.lineTo(p.x, p.y); ctx.stroke();
    });
    drawCanvas.addEventListener('pointerup', () => drawing = false);
    drawCanvas.addEventListener('pointerleave', () => drawing = false);
    clearDrawBtn.addEventListener('click', () => ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height));

    // page buttons
    createStickerBtn.addEventListener('click', () => showPage('draw'));
    backToHomeBtn.addEventListener('click', () => showPage('home'));
    backFromMapBtn.addEventListener('click', () => showPage('home'));

    // Map init (Leaflet)
    let leafletMap = null;
    const mapMarkers = [];
    async function initMap() {
      if (!leafletMap) {
        // try to get user location
        try {
          const coords = await getCurrentPosition();
          userCoords = coords;
        } catch(e){ console.warn('Map: no gps yet'); }
        leafletMap = L.map('map', { zoomControl: true }).setView([userCoords?.lat ?? 40.7589, userCoords?.lon ?? -73.9851], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(leafletMap);
      }
      // clear
      mapMarkers.forEach(m => leafletMap.removeLayer(m)); mapMarkers.length = 0;
      // add markers from DB (cached allStickerData)
      try {
        const snapshot = await window._fb.get(window._fb.stickersRef);
        const data = snapshot.val();
        if (!data) return;
        Object.entries(data).forEach(([id, item]) => {
          const m = L.marker([item.lat, item.lon]).addTo(leafletMap);
          m.bindPopup(`<div style="width:160px"><img src="${item.image}" style="width:100%;height:auto;border-radius:8px;"/><div style="font-size:12px;margin-top:6px">Placed: ${new Date(item.createdAt).toLocaleString()}</div></div>`);
          mapMarkers.push(m);
        });
      } catch(e) { console.warn('Map load err',e); }
    }

    mapBtn.addEventListener('click', () => { showPage('map'); setTimeout(initMap, 120); });

    // utility: get current position (promise)
    function getCurrentPosition() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('No geolocation'));
        navigator.geolocation.getCurrentPosition(
          (p) => resolve({ lat: p.coords.latitude, lon: p.coords.longitude, alt: p.coords.altitude ?? 0, accuracy: p.coords.accuracy }),
          reject,
          { enableHighAccuracy: true, maximumAge: 2000, timeout: 15000 }
        );
      });
    }

    // device orientation capture (heading + quaternion)
    window.addEventListener('deviceorientation', (ev) => {
      // alpha = rotation around z axis (0..360), many browsers it's relative to north when absolute true
      if (ev.alpha !== null) lastCompass = ev.alpha;
      // capture quaternion from alpha/beta/gamma using same transform AR.js uses
      // simpler: store angles for saving; we will also store orientation quaternion calculated by THREE
      // Build quaternion using THREE (we have aframe/three loaded)
      try {
        const threeEuler = new THREE.Euler(
          (ev.beta ?? 0) * Math.PI/180,
          (ev.alpha ?? 0) * Math.PI/180,
          -(ev.gamma ?? 0) * Math.PI/180,
          'YXZ'
        );
        const q = new THREE.Quaternion().setFromEuler(threeEuler);
        lastQuat = { _x: q.x, _y: q.y, _z: q.z, _w: q.w };
      } catch(e){}
    }, true);

    // Save sticker -> push to firebase (image dataURL + gps + heading + quaternion snapshot)
    saveStickerBtn.addEventListener('click', async () => {
      // make dataURL
      pendingStickerImage = drawCanvas.toDataURL('image/png');
      // go to AR mode to place it
      showPage('ar');
      await startARMode(true);
    });

    // AR mode helpers (uses AR.js / A-Frame)
    let arScene = null;
    let arCameraEntity = null;
    let arEntities = {}; // id -> entity
    const MAX_RENDER_DISTANCE = 120; // meters

    // create a-view element handle
    function ensureARScene() {
      arScene = document.querySelector('a-scene');
      if (!arScene) throw new Error('a-scene not found');
      arCameraEntity = arScene.querySelector('[gps-camera]') || (function(){ const c=document.createElement('a-entity'); c.setAttribute('gps-camera',''); arScene.appendChild(c); return c; })();
    }

    // create A-Frame image entity at lat/lon with rotation from heading
    function createStickerEntity(id, item) {
      // if entity exists, skip
      if (arEntities[id]) return arEntities[id];

      const a = document.createElement('a-image');
      a.setAttribute('gps-entity-place', `latitude: ${item.lat}; longitude: ${item.lon};`);
      a.setAttribute('src', item.image);
      a.setAttribute('width', item.sizeMeters ?? 1.2);
      a.setAttribute('height', item.sizeMeters ?? 1.2);
      // set vertical to horizontal: AR.js places image vertical by default — we want sticker flat on wall or ground?
      // default: make sticker vertical (like a poster). If you prefer floor decals, rotate -90 on X.
      const rotY = (item.heading != null) ? item.heading : 0; // degrees
      // rotate so the image faces the same compass heading it was created with
      // We set rotation as: rotation = "-90 Y 0" for floor; for vertical poster use "0 Y 0"
      // We'll use vertical poster here: rotation = "0 rotY 0"
      a.setAttribute('rotation', `0 ${rotY} 0`);
      a.setAttribute('look-at', '[gps-camera]'); // optional: make it face camera for readability
      a.setAttribute('class', 'sticker-entity');

      // hide by default; AR.js will position it later
      a.style.display = 'none';

      // add to scene
      arScene.appendChild(a);
      arEntities[id] = a;

      // once placed by AR.js (gps-entity-place sets object3D.position), show it
      // Use a small interval to check distance to user and set visibility
      const checkInterval = setInterval(() => {
        if (!userCoords) return;
        const d = haversineDistance(userCoords.lat, userCoords.lon, item.lat, item.lon);
        // show only within range to avoid clutter and performance problems
        if (d < MAX_RENDER_DISTANCE) {
          a.style.display = '';
        } else {
          a.style.display = 'none';
        }
      }, 1000);

      // Return entity
      return a;
    }

    // load stickers from firebase, create entities
    function startListeningForStickers() {
      // initial fetch + child_added listener
      window._fb.onChildAdded(window._fb.stickersRef, (snap) => {
        const id = snap.key; const data = snap.val();
        // create entity (if AR scene exists)
        try { createStickerEntity(id, data); } catch(e){ /* deferred until ar scene ready */ }
      });

      // removal
      window._fb.onChildRemoved(window._fb.stickersRef, (snap) => {
        const id = snap.key;
        if (arEntities[id]) {
          arEntities[id].parentNode.removeChild(arEntities[id]);
          delete arEntities[id];
        }
      });
    }

    // Haversine distance (meters)
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = (d) => d * Math.PI/180;
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const Δφ = toRad(lat2 - lat1), Δλ = toRad(lon2 - lon1);
      const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Place sticker action (when user clicks Place Here)
    placeStickerBtn.addEventListener('click', async () => {
      placeStickerBtn.disabled = true;
      arStatus.innerText = 'Placing sticker...';
      try {
        // get fresh gps if possible
        try { userCoords = await getCurrentPosition(); } catch(e){ /* ignore */ }

        if (!pendingStickerImage || !userCoords) {
          arStatus.innerText = 'Need GPS & image';
          placeStickerBtn.disabled = false;
          return;
        }

        // build data
        const data = {
          image: pendingStickerImage,
          lat: userCoords.lat,
          lon: userCoords.lon,
          alt: userCoords.alt ?? 0,
          accuracy: userCoords.accuracy ?? 999,
          owner: localStorage.getItem('ar_stickers_uid') ?? ('user_' + Date.now().toString(36)),
          createdAt: Date.now(),
          heading: (lastCompass != null) ? lastCompass : null,
          orientationQuaternion: lastQuat || { _x:0,_y:0,_z:0,_w:1 },
          sizeMeters: 1.2
        };

        // push to Firebase
        await window._fb.push(window._fb.stickersRef, data);
        arStatus.innerText = 'Sticker placed!';
        pendingStickerImage = null;
        placeStickerBtn.style.display = 'none';
      } catch (e) {
        console.error('Place error', e);
        arStatus.innerText = 'Failed to place sticker';
        placeStickerBtn.disabled = false;
      }
    });

    // Start AR mode: ensure permissions, initialize scene, load stickers
    async function startARMode(placing = false) {
      showPage('ar');
      arStatus.innerText = 'Starting AR...';

      // ensure scene exists
      ensureARScene();

      // request permissions: camera + geo + orientation
      try {
        // geolocation permission handled by getCurrentPosition
        try { userCoords = await getCurrentPosition(); } catch(e){ console.warn('GPS denied/timeout',e); }
      } catch(e){ console.warn('GPS err',e); }

      // show Place button if placing
      if (placing && pendingStickerImage) { placeStickerBtn.style.display = ''; placeStickerBtn.disabled = false; }
      else placeStickerBtn.style.display = 'none';

      // start listening for stickers from db (creates aframe entities)
      startListeningForStickers();

      // create existing stickers right away (if any were fetched earlier)
      try {
        const snapshot = await window._fb.get(window._fb.stickersRef);
        const data = snapshot.val();
        if (data) {
          Object.entries(data).forEach(([id, item]) => createStickerEntity(id, item));
        }
      } catch(e){ console.warn('initial stickers load failed', e); }

      // update UI
      arStatus.innerText = 'AR ready — move slowly to let GPS & AR.js position items';
    }

    // Stop AR: remove entities (keeps DB intact)
    function stopARMode() {
      // remove sticker elements from scene to free memory
      Object.keys(arEntities).forEach(id => {
        try { arEntities[id].parentNode.removeChild(arEntities[id]); } catch(e){}
      });
      Object.keys(arEntities).forEach(k => delete arEntities[k]);
      arStatus.innerText = 'Exited AR';
    }

    exitArBtn.addEventListener('click', () => {
      stopARMode();
      showPage('home');
    });

    exploreBtn.addEventListener('click', async () => {
      await startARMode(false);
    });

    // initial DB listeners for map/home preview (not AR entities)
    (async function preloadAll() {
      try {
        const snapshot = await window._fb.get(window._fb.stickersRef);
        const data = snapshot.val();
        // nothing else needed — AR listener will create entities
      } catch(e){}
    })();

    // Expose function to be used by initial firebase onChildAdded loaded earlier
    // but everything is handled via window._fb.onChildAdded inside startListeningForStickers

    // utility: generate unique id (same as original)
    function getUniqueUserId() {
      let uid = localStorage.getItem("ar_stickers_uid");
      if (!uid) {
        uid = "user_" + Date.now().toString(36) + "_" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("ar_stickers_uid", uid);
      }
      return uid;
    }
  } // end mainInit
  </script>

</body>
</html>
