<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#000000" />
  <title>GPS AR Stickers</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.171.0/build/three.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #fff;
    }

    /* ===== PAGES ===== */
    .page {
      position: fixed;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }
    
    .page.active {
      display: flex;
    }

    /* ===== DRAW PAGE ===== */
    #drawPage {
      justify-content: flex-start;
      padding-top: 60px;
    }

    #drawCanvas {
      width: 90vw;
      max-width: 400px;
      height: 90vw;
      max-height: 400px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      touch-action: none;
      cursor: crosshair;
    }

    .draw-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      margin: 20px 0;
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .draw-controls label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
    }

    input[type="color"] {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      cursor: pointer;
      background: transparent;
    }

    input[type="range"] {
      width: 120px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .btn-danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: #fff;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* ===== AR PAGE ===== */
    #arPage {
      padding: 0;
      background: transparent;
    }

    #arPage video, #arPage canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #arPage video {
      z-index: 0;
    }

    #arPage canvas {
      z-index: 1;
    }

    .ar-ui {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      display: flex;
      gap: 12px;
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 20px;
      backdrop-filter: blur(15px);
    }

    .ar-status {
      position: fixed;
      top: calc(env(safe-area-inset-top, 20px) + 20px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 12px;
      backdrop-filter: blur(15px);
      font-size: 14px;
      max-width: 90vw;
      text-align: center;
    }

    .sticker-info {
      position: fixed;
      top: calc(env(safe-area-inset-top, 20px) + 70px);
      right: 20px;
      z-index: 10;
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 10px;
      backdrop-filter: blur(10px);
      font-size: 12px;
      max-width: 150px;
    }

    .sticker-count {
      color: #00ffd0;
      font-weight: 700;
      font-size: 20px;
    }

    /* ===== HOME PAGE ===== */
    #homePage h1 {
      font-size: 42px;
      font-weight: 800;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #homePage p {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 40px;
      max-width: 300px;
      text-align: center;
      line-height: 1.6;
    }

    .home-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      max-width: 280px;
    }

    /* ===== RETICLE ===== */
    .reticle {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 3px solid #00ffd0;
      border-radius: 50%;
      z-index: 5;
      pointer-events: none;
      box-shadow: 0 0 20px rgba(0, 255, 208, 0.6);
    }

    .reticle::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: #00ffd0;
      border-radius: 50%;
    }

    /* ===== MAP PAGE ===== */
    #mapPage {
      padding: 0;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* Loading indicator */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- HOME PAGE -->
  <div id="homePage" class="page active">
    <h1>AR Stickers</h1>
    <p>Create stickers and place them anywhere in the world. Discover others' art!</p>
    <div class="home-buttons">
      <button id="createStickerBtn" class="btn btn-primary">Create Sticker</button>
      <button id="exploreBtn" class="btn btn-secondary">Explore Stickers</button>
      <button id="mapBtn" class="btn btn-secondary">View Map</button>
    </div>
  </div>

  <!-- MAP PAGE -->
  <div id="mapPage" class="page">
    <div id="map"></div>
    <div class="ar-status" style="top: 20px;">Sticker Map</div>
    <div class="ar-ui">
      <button id="backFromMapBtn" class="btn btn-secondary">Back</button>
    </div>
  </div>

  <!-- DRAW PAGE -->
  <div id="drawPage" class="page">
    <canvas id="drawCanvas" width="512" height="512"></canvas>
    
    <div class="draw-controls">
      <label>Color:</label>
      <input id="colorPicker" type="color" value="#FF1493" />
      
      <label>Size:</label>
      <input id="sizeRange" type="range" min="2" max="40" value="8" />
    </div>

    <div class="btn-group">
      <button id="clearDrawBtn" class="btn btn-secondary">Clear</button>
      <button id="saveStickerBtn" class="btn btn-primary">Save & Place</button>
    </div>
    
    <div class="btn-group" style="margin-top: 10px;">
      <button id="backToHomeBtn" class="btn btn-secondary">Back</button>
    </div>
  </div>

  <!-- AR PAGE -->
  <div id="arPage" class="page">
    <video id="arVideo" autoplay playsinline muted></video>
    <canvas id="three-canvas"></canvas>
    
    <div class="reticle"></div>
    
    <div class="ar-status" id="arStatus">Initializing AR...</div>
    
    <div class="sticker-info">
      <div>Nearby Stickers:</div>
      <div class="sticker-count" id="stickerCount">0</div>
    </div>
    
    <div class="ar-ui">
      <button id="placeStickerBtn" class="btn btn-primary" style="display:none;">Place Here</button>
      <button id="exitArBtn" class="btn btn-danger">Exit AR</button>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Main Application Script -->
  <script>
    console.log("ðŸš€ AR Stickers App Starting...");

    // ===== SIMPLE NAVIGATION SYSTEM =====
    const homePage = document.getElementById("homePage");
    const drawPage = document.getElementById("drawPage");
    const arPage = document.getElementById("arPage");
    const mapPage = document.getElementById("mapPage");

    function showPage(pageName) {
      console.log("Navigating to:", pageName);
      
      // Hide all pages
      [homePage, drawPage, arPage, mapPage].forEach(p => {
        p.classList.remove("active");
      });
      
      // Show selected page
      if (pageName === "home") {
        homePage.classList.add("active");
      } else if (pageName === "draw") {
        drawPage.classList.add("active");
      } else if (pageName === "ar") {
        arPage.classList.add("active");
        // Start AR when showing AR page
        setTimeout(() => enterARMode(false), 100);
      } else if (pageName === "map") {
        mapPage.classList.add("active");
        // Initialize map when shown
        setTimeout(() => initMap(), 100);
      }
    }

    // ===== FIREBASE CONFIG =====
    const firebaseConfig = {
      apiKey: "AIzaSyBCzRpUX5mexhGj5FzqEWKoFAdljNJdbHE",
      authDomain: "surfaceless-firebase.firebaseapp.com",
      databaseURL: "https://surfaceless-firebase-default-rtdb.firebaseio.com",
      projectId: "surfaceless-firebase",
      storageBucket: "surfaceless-firebase.firebasestorage.app",
      messagingSenderId: "91893983357",
      appId: "1:91893983357:web:a823ba9f5874bede8b6914"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.getDatabase(app);
    const stickersRef = firebase.ref(db, "stickers");

    // ===== STATE VARIABLES =====
    let userGPS = null;
    let cameraStream = null;
    let pendingStickerImage = null;
    let leafletMap = null;
    let mapMarkers = [];
    let allStickerData = [];

    // ===== THREE.JS SETUP =====
    let renderer, scene, camera;
    const stickerMeshes = new Map();

    function initThreeJS() {
      // Create renderer
      renderer = new THREE.WebGLRenderer({
        canvas: document.getElementById("three-canvas"),
        antialias: true,
        alpha: true
      });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.outputEncoding = THREE.sRGBEncoding;

      // Create scene
      scene = new THREE.Scene();
      scene.background = null;

      // Create camera
      camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(0, 1.6, 0);

      // Add light
      const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
      scene.add(light);

      console.log("Three.js initialized");
    }

    // ===== GPS UTILITIES =====
    const EARTH_RADIUS = 6378137;
    const WORLD_ORIGIN = { lat: 40.758896, lon: -73.985130 };

    function gpsToAbsoluteWorldPosition(lat, lon) {
      const earthRadius = 6378137;
      const latRad = lat * Math.PI / 180;
      const lonRad = lon * Math.PI / 180;
      const originLatRad = WORLD_ORIGIN.lat * Math.PI / 180;
      const originLonRad = WORLD_ORIGIN.lon * Math.PI / 180;
      
      const dLat = latRad - originLatRad;
      const dLon = lonRad - originLonRad;
      
      const x = dLon * earthRadius * Math.cos(originLatRad);
      const z = -dLat * earthRadius;
      
      return { x, z };
    }

    function getCurrentGPS() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          return reject(new Error("Geolocation not available"));
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve(pos.coords),
          reject,
          { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
        );
      });
    }

    // ===== STICKER CREATION =====
    function createStickerMesh(base64Image, sizeMeters = 1.0) {
      return new Promise((resolve) => {
        const textureLoader = new THREE.TextureLoader();
        textureLoader.load(base64Image, (texture) => {
          texture.encoding = THREE.sRGBEncoding;
          
          const geometry = new THREE.PlaneGeometry(sizeMeters, sizeMeters);
          const material = new THREE.MeshBasicMaterial({
            map: texture,
            transparent: true,
            side: THREE.DoubleSide,
            depthWrite: false,
            opacity: 0.9
          });
          
          const mesh = new THREE.Mesh(geometry, material);
          mesh.rotation.x = 0;
          mesh.position.y = 0.5;
          mesh.matrixAutoUpdate = false;
          
          resolve(mesh);
        });
      });
    }

    // ===== AR MODE FUNCTIONS =====
    async function enterARMode(placingSticker = false) {
      console.log("Entering AR mode...");
      document.getElementById("arStatus").textContent = "Starting camera...";

      // Initialize Three.js if not already done
      if (!renderer) {
        initThreeJS();
      }

      // Start camera
      try {
        if (cameraStream) {
          cameraStream.getTracks().forEach(t => t.stop());
        }
        
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: { ideal: "environment" },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });
        
        const arVideo = document.getElementById("arVideo");
        arVideo.srcObject = cameraStream;
        await arVideo.play();
        
        document.getElementById("arStatus").textContent = "Camera started. Getting GPS...";
      } catch (e) {
        console.error("Camera error:", e);
        document.getElementById("arStatus").textContent = "Camera permission required";
        return;
      }

      // Get GPS
      try {
        const coords = await getCurrentGPS();
        userGPS = {
          lat: coords.latitude,
          lon: coords.longitude,
          alt: coords.altitude || 0,
          accuracy: coords.accuracy
        };

        // Set camera position based on GPS
        const worldPos = gpsToAbsoluteWorldPosition(userGPS.lat, userGPS.lon);
        camera.position.x = worldPos.x;
        camera.position.z = worldPos.z;
        camera.position.y = 1.6;

        document.getElementById("arStatus").textContent = `GPS locked! Position: ${userGPS.lat.toFixed(4)}, ${userGPS.lon.toFixed(4)}`;
        console.log("Camera positioned at world coordinates:", worldPos);

      } catch (e) {
        console.error("GPS error:", e);
        document.getElementById("arStatus").textContent = "GPS required for AR";
        return;
      }

      // Start rendering
      startRendering();

      // Show place sticker button if needed
      if (placingSticker && pendingStickerImage) {
        document.getElementById("placeStickerBtn").style.display = "";
        document.getElementById("arStatus").textContent = "Ready to place sticker! Look around and tap Place when ready.";
      } else {
        document.getElementById("placeStickerBtn").style.display = "none";
        document.getElementById("arStatus").textContent = "AR mode active. Look around to see stickers!";
      }

      // Load existing stickers
      loadStickers();
    }

    function exitARMode() {
      console.log("Exiting AR mode");
      
      // Stop camera
      if (cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
        cameraStream = null;
      }
      
      // Stop rendering
      stopRendering();
      
      // Clear pending sticker
      pendingStickerImage = null;
      
      // Return to home
      showPage("home");
    }

    // ===== RENDER LOOP =====
    let isRendering = false;

    function startRendering() {
      if (isRendering) return;
      isRendering = true;
      
      function animate() {
        if (!isRendering) return;
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      
      animate();
      console.log("Rendering started");
    }

    function stopRendering() {
      isRendering = false;
      console.log("Rendering stopped");
    }

    // ===== STICKER MANAGEMENT =====
    async function loadStickers() {
      try {
        const snapshot = await firebase.get(stickersRef);
        const data = snapshot.val();
        
        if (data) {
          allStickerData = Object.entries(data).map(([id, val]) => ({ id, ...val }));
          
          // Create meshes for each sticker
          for (const sticker of allStickerData) {
            if (sticker.image && sticker.lat && sticker.lon) {
              const mesh = await createStickerMesh(sticker.image, 1.0);
              const worldPos = gpsToAbsoluteWorldPosition(sticker.lat, sticker.lon);
              
              mesh.position.x = worldPos.x;
              mesh.position.z = worldPos.z;
              mesh.position.y = 0.5;
              mesh.updateMatrix();
              
              scene.add(mesh);
              stickerMeshes.set(sticker.id, { mesh, data: sticker });
              
              console.log(`Loaded sticker at world position: (${worldPos.x.toFixed(1)}, ${worldPos.z.toFixed(1)})`);
            }
          }
          
          document.getElementById("stickerCount").textContent = allStickerData.length;
          document.getElementById("arStatus").textContent = `Loaded ${allStickerData.length} stickers!`;
        }
      } catch (error) {
        console.error("Error loading stickers:", error);
      }
    }

    async function placeSticker() {
      if (!pendingStickerImage || !userGPS) {
        alert("No sticker image or GPS available");
        return;
      }

      try {
        const stickerData = {
          image: pendingStickerImage,
          lat: userGPS.lat,
          lon: userGPS.lon,
          alt: userGPS.alt,
          accuracy: userGPS.accuracy,
          owner: getUniqueUserId(),
          createdAt: Date.now()
        };
        
        await firebase.push(stickersRef, stickerData);
        
        document.getElementById("arStatus").textContent = "Sticker placed successfully!";
        document.getElementById("placeStickerBtn").style.display = "none";
        pendingStickerImage = null;
        
        // Clear drawing
        const drawCtx = document.getElementById("drawCanvas").getContext("2d");
        drawCtx.clearRect(0, 0, 512, 512);
        
      } catch (error) {
        console.error("Error placing sticker:", error);
        document.getElementById("arStatus").textContent = "Failed to place sticker";
      }
    }

    function getUniqueUserId() {
      let uid = localStorage.getItem("ar_stickers_uid");
      if (!uid) {
        uid = "user_" + Date.now().toString(36) + "_" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("ar_stickers_uid", uid);
      }
      return uid;
    }

    // ===== DRAWING FUNCTIONALITY =====
    const drawCanvas = document.getElementById("drawCanvas");
    const drawCtx = drawCanvas.getContext("2d");
    let isDrawing = false;

    function getDrawPos(e) {
      const rect = drawCanvas.getBoundingClientRect();
      const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
      const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
      return {
        x: x * (drawCanvas.width / rect.width),
        y: y * (drawCanvas.height / rect.height)
      };
    }

    drawCanvas.addEventListener("pointerdown", (e) => {
      isDrawing = true;
      drawCtx.strokeStyle = document.getElementById("colorPicker").value;
      drawCtx.lineWidth = parseInt(document.getElementById("sizeRange").value);
      drawCtx.lineCap = "round";
      drawCtx.lineJoin = "round";
      const pos = getDrawPos(e);
      drawCtx.beginPath();
      drawCtx.moveTo(pos.x, pos.y);
    });

    drawCanvas.addEventListener("pointermove", (e) => {
      if (!isDrawing) return;
      const pos = getDrawPos(e);
      drawCtx.lineTo(pos.x, pos.y);
      drawCtx.stroke();
    });

    drawCanvas.addEventListener("pointerup", () => isDrawing = false);
    drawCanvas.addEventListener("pointerleave", () => isDrawing = false);

    // ===== MAP FUNCTIONALITY =====
    function initMap() {
      console.log("Initializing map...");
      try {
        // Create map centered on user location or default
        const center = userGPS ? [userGPS.lat, userGPS.lon] : [40.7589, -73.9851];
        leafletMap = L.map('map').setView(center, 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap',
          maxZoom: 19
        }).addTo(leafletMap);
        
        // Add user marker if GPS available
        if (userGPS) {
          L.marker([userGPS.lat, userGPS.lon]).addTo(leafletMap)
            .bindPopup('Your Location')
            .openPopup();
        }
        
        // Add sticker markers
        updateMapMarkers();
        
        console.log("Map initialized successfully");
      } catch (error) {
        console.error("Map initialization failed:", error);
      }
    }

    function updateMapMarkers() {
      if (!leafletMap) return;
      
      // Clear existing markers
      mapMarkers.forEach(m => leafletMap.removeLayer(m));
      mapMarkers = [];
      
      // Add markers for each sticker
      allStickerData.forEach((data) => {
        if (!data.lat || !data.lon) return;
        
        const marker = L.marker([data.lat, data.lon]).addTo(leafletMap);
        
        if (data.image) {
          marker.bindPopup(`<img src="${data.image}" style="width:100px;height:100px;object-fit:contain;"/>`);
        }
        
        mapMarkers.push(marker);
      });
    }

    // ===== BUTTON EVENT LISTENERS =====
    document.getElementById("createStickerBtn").addEventListener("click", () => {
      showPage("draw");
    });

    document.getElementById("exploreBtn").addEventListener("click", () => {
      showPage("ar");
    });

    document.getElementById("mapBtn").addEventListener("click", () => {
      showPage("map");
    });

    document.getElementById("saveStickerBtn").addEventListener("click", () => {
      // Save drawing and prepare for AR placement
      pendingStickerImage = document.getElementById("drawCanvas").toDataURL("image/png");
      showPage("ar");
    });

    document.getElementById("placeStickerBtn").addEventListener("click", () => {
      placeSticker();
    });

    document.getElementById("exitArBtn").addEventListener("click", () => {
      exitARMode();
    });

    document.getElementById("backToHomeBtn").addEventListener("click", () => {
      showPage("home");
    });

    document.getElementById("backFromMapBtn").addEventListener("click", () => {
      showPage("home");
    });

    document.getElementById("clearDrawBtn").addEventListener("click", () => {
      drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    });

    // ===== WINDOW RESIZE HANDLER =====
    window.addEventListener("resize", () => {
      if (renderer) {
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      }
    });

    console.log("âœ… AR Stickers App Fully Loaded!");
    console.log("All features should now work:");

  </script>
</body>
</html>